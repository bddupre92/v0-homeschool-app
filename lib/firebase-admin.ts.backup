// Check if we're in a build environment first
const isBuildEnvironment = 
  process.env.NEXT_PHASE === "phase-production-build" ||
  process.env.NEXT_PHASE === "phase-export" ||
  typeof window === "undefined" && process.env.NODE_ENV !== "development" && !process.env.VERCEL

// Only import Firebase Admin if not in build environment
let initializeApp: any, getApps: any, cert: any, getFirestore: any, getAuth: any, getStorage: any

if (!isBuildEnvironment) {
  try {
    const adminApp = require("firebase-admin/app")
    const adminFirestore = require("firebase-admin/firestore")
    const adminAuth = require("firebase-admin/auth")
    const adminStorage = require("firebase-admin/storage")
    
    initializeApp = adminApp.initializeApp
    getApps = adminApp.getApps
    cert = adminApp.cert
    getFirestore = adminFirestore.getFirestore
    getAuth = adminAuth.getAuth
    getStorage = adminStorage.getStorage
  } catch (error) {
    console.log("Firebase Admin modules not available, using mocks")
  }
}

// Create mock implementations for build environment
const createMockFirestore = () => {
  return {
    collection: (name: string) => ({
      get: async () => ({ docs: [] }),
      doc: (id?: string) => ({
        id: id || "mock-doc-id",
        get: async () => ({ 
          exists: false, 
          data: () => ({}),
          id: id || "mock-doc-id"
        }),
        set: async () => {},
        update: async () => {},
        delete: async () => {},
      }),
      add: async () => ({ id: "mock-doc-id" }),
      where: () => ({
        get: async () => ({ docs: [] }),
      }),
    }),
    FieldValue: {
      arrayUnion: (...values: any[]) => ({ _methodName: "arrayUnion", _elements: values }),
      arrayRemove: (...values: any[]) => ({ _methodName: "arrayRemove", _elements: values }),
      serverTimestamp: () => ({ _methodName: "serverTimestamp" }),
    },
  }
}

const createMockAuth = () => {
  return {
    getUser: async () => ({}),
    createUser: async () => ({}),
    updateUser: async () => ({}),
    deleteUser: async () => {},
    verifySessionCookie: async () => ({ uid: "mock-user-id" }),
    createSessionCookie: async () => "mock-session-cookie",
  }
}

const createMockStorage = () => {
  return {
    bucket: () => ({
      file: () => ({
        save: async () => {},
        download: async () => [Buffer.from("")],
      }),
      getFiles: async () => [[]],
    }),
  }
}

// Initialize Firebase Admin or use mocks
let adminDb: any, adminAuth: any, adminStorage: any

if (isBuildEnvironment || !initializeApp) {
  console.log("Using mock Firebase Admin for build environment")
  adminDb = createMockFirestore()
  adminAuth = createMockAuth()
  adminStorage = createMockStorage()
} else {
  // Only initialize Firebase Admin in non-build environments
  try {
    if (!getApps().length) {
      // If we're in a production environment, use the environment variables
      if (process.env.FIREBASE_ADMIN_PRIVATE_KEY && process.env.FIREBASE_ADMIN_PROJECT_ID && process.env.FIREBASE_ADMIN_CLIENT_EMAIL) {
        initializeApp({
          credential: cert({
            projectId: process.env.FIREBASE_ADMIN_PROJECT_ID,
            clientEmail: process.env.FIREBASE_ADMIN_CLIENT_EMAIL,
            privateKey: process.env.FIREBASE_ADMIN_PRIVATE_KEY.replace(/\\n/g, "\n"),
          }),
          projectId: process.env.FIREBASE_ADMIN_PROJECT_ID,
        })
        console.log("Firebase Admin initialized with environment variables")
      } else {
        // Initialize with a minimal configuration for development/preview
        initializeApp({
          projectId: "demo-homeschool-app",
        })
        console.log("Firebase Admin initialized with minimal config (no credentials)")
      }
    }

    // Get the admin services
    adminDb = getFirestore()
    adminAuth = getAuth()
    adminStorage = getStorage()
  } catch (error) {
    console.error("Firebase Admin initialization error:", error)
    // Use mocks as fallback
    console.log("Using mock Firebase Admin due to error")
    adminDb = createMockFirestore()
    adminAuth = createMockAuth()
    adminStorage = createMockStorage()
  }
}

// Export the admin services
export const db = adminDb
export { adminDb, adminAuth, adminStorage }
